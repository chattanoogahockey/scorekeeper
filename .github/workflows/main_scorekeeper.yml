# Docs for the Azure Web Apps Deploy action: https://github.com/Azure/webapps-deploy
# More GitHub Actions for Azure: https://github.com/Azure/actions

name: 'Build and deploy Node.js app to Azure Web App: scorekeeper'

on:
  push:
    branches:
    - main
  workflow_dispatch:

# Ensure only one deployment runs at a time
concurrency:
  group: production-deployment
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Show deployment info
      run: |
        echo "🚀 Deploying commit: ${{ github.sha }}"
        echo "📝 Commit message: ${{ github.event.head_commit.message }}"
        echo "👤 Author: ${{ github.event.head_commit.author.name }}"
        echo "⏰ Timestamp: $(date -u)"

    - name: Fetch full git history
      run: |
        git fetch --unshallow --tags || true

    - name: Set up Node.js version
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Clean and install dependencies
      run: |
        rm -rf node_modules
        npm install
    
    - name: Build frontend
      run: |
        cd frontend
        npm install
        # Generate version info with deployment timestamp
        NODE_ENV=production DEPLOYMENT_TIMESTAMP=$DEPLOYMENT_TIMESTAMP node generate-version.js
        npm run build
    
    - name: Install backend dependencies
      run: |
        cd backend  
        npm install --production
    
    - name: Create deployment package
      run: |
        mkdir -p deploy
        # Copy backend files to root of deploy
        cp -r backend/* deploy/
        # CRITICAL: Copy backend node_modules to deploy
        cp -r backend/node_modules deploy/node_modules
        # CRITICAL: Copy built frontend to where backend serves it
        rm -rf deploy/frontend
        mkdir -p deploy/frontend
        cp -r frontend/dist/* deploy/frontend/
        # Copy root package.json and web.config
        cp package.json deploy/
        cp web.config deploy/
        # Verify frontend was copied correctly
        echo "Frontend files copied:"
        ls -la deploy/frontend/
        # Verify node_modules copied
        echo "Backend dependencies copied:"
        ls -la deploy/node_modules/ | head -10
    
    - name: Create deployment environment
      run: |
        # Create .env file for deployment with git info
        echo "BUILD_SOURCEVERSION=${{ github.sha }}" >> deploy/.env
        echo "BUILD_SOURCEBRANCH=${{ github.ref_name }}" >> deploy/.env
        echo "DEPLOYMENT_TIMESTAMP=$DEPLOYMENT_TIMESTAMP" >> deploy/.env
        echo "GITHUB_ACTIONS=true" >> deploy/.env
        echo "Environment variables for deployment:"
        cat deploy/.env

    - name: Set deployment timestamp (Eastern Time) - Just before deployment
      run: echo "DEPLOYMENT_TIMESTAMP=$(TZ='America/New_York' date +%Y-%m-%dT%H:%M:%S%z)" >> $GITHUB_ENV

    - name: 'Deploy to Azure Web App'
      uses: azure/webapps-deploy@v3
      with: 
        app-name: 'scorekeeper'
        slot-name: 'production'
        publish-profile: ${{ secrets.AzureAppService_PublishProfile_aa98474905f14a53afdc3e9da94e0ae4 }}
        package: './deploy'

    - name: Verify deployment
      run: |
        # Wait a moment for deployment to complete
        sleep 30
        # Check health endpoint
        curl -sSf https://scorekeeper.azurewebsites.net/api/health || echo "Health check failed"
        # Check version endpoint and verify it matches package.json
        curl -sSf https://scorekeeper.azurewebsites.net/api/version | tee /tmp/version.json
        if command -v jq > /dev/null; then
          DEPLOYED_VERSION=$(jq -r .version /tmp/version.json)
          PACKAGE_VERSION=$(jq -r .version package.json)
          echo "Deployed version: $DEPLOYED_VERSION"
          echo "Package version: $PACKAGE_VERSION"
          if [ "$DEPLOYED_VERSION" != "$PACKAGE_VERSION" ]; then
            echo "ERROR: Version mismatch!"
            exit 1
          fi
          echo "✅ Version verification successful"
        else
          echo "jq not available, skipping version verification"
        fi
