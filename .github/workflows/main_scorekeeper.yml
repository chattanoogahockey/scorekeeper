# Docs for the Azure Web Apps Deploy action: https://github.com/Azure/webapps-deploy
# More GitHub Actions for Azure: https://github.com/Azure/actions
# Updated: 2025-09-06 - Force workflow trigger

name: 'Deploy scorekeeper (minimal)'

on:
  push:
    branches:
    - main
  workflow_dispatch:

# Ensure only one deployment runs at a time
concurrency:
  group: production-deployment
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Info
        run: |
          echo "Deploying commit ${{ github.sha }} at $(date -u)"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Build frontend
        run: |
          cd frontend
          npm ci
          npm run build

      - name: Prepare minimal package
        run: |
          mkdir package
          cp server.js package/
          cp package.json package/
          cp web.config package/ || true
          # copy built frontend
          mkdir -p package/frontend/dist
          cp -r frontend/dist/* package/frontend/dist/
          cd package
          npm install --production --no-audit --no-fund
          cd ..
          echo "Contents:"; ls -R package | head -100
          zip -r deploy.zip package
          echo "Zip size:"; du -h deploy.zip

      - name: Azure Deploy (zip)
        uses: azure/webapps-deploy@v3
        with:
          app-name: 'scorekeeper'
          publish-profile: ${{ secrets.AzureAppService_PublishProfile_aa98474905f14a53afdc3e9da94e0ae4 }}
          package: deploy.zip

      - name: Post-deploy health check
        run: |
          echo "Waiting for warmup..."; sleep 20
          curl -v --retry 10 --retry-delay 5 https://scorekeeper.azurewebsites.net/api/health || true
