import{G as Q,j as s}from"./index-CRuzh1EF.js";import{b as x}from"./react-vendor-6tIi07-H.js";import{a as H}from"./ui-vendor-NIGUFBhG.js";const X={male:{preferredNames:["Daniel","David","Alex"],settings:{rate:.95,pitch:.65,volume:1}},female:{preferredNames:["Samantha","Karen","Moira"],settings:{rate:1,pitch:1.1,volume:1}}};function Y(n,y=[]){const u=X[n];if(!u)throw new Error(`Invalid speaker type: ${n}. Must be 'male' or 'female'.`);let h=null;if(y&&y.length>0){const A=y.filter(S=>S.lang.startsWith("en")&&u.preferredNames.some(j=>S.name.includes(j)));A.length>0&&(h=A[0])}return{voice:h,settings:{...u.settings},preferredNames:[...u.preferredNames]}}function Z(n,y,u){const h=Y(y,u);return h.voice&&(n.voice=h.voice),n.rate=h.settings.rate,n.pitch=h.settings.pitch,n.volume=h.settings.volume,n}function ee(n=[]){if(!n||n.length===0)return null;const y=n.filter(u=>u.lang.startsWith("en")&&(u.name.includes("Samantha")||u.name.includes("Daniel")||u.default));return y.length>0?y[0]:null}function te(n,y){const u=ee(y);return u&&(n.voice=u),n.rate=.9,n.pitch=1,n.volume=1,n}async function M(n,y,u){const A={goal:"/api/goals/announce-last",penalty:"/api/penalties/announce-last",random:"/api/randomCommentary"};if(!A[n])throw new Error(`Invalid announcement type: ${n}`);const S=u==="dual"?"dual":"single";return(await H.post(`${A[n]}`,{gameId:y,voiceGender:u,announcerMode:S})).data}function U(n,y="announcement"){throw n.response?.status===503?new Error("Announcer service temporarily unavailable"):n.response?.status===400?new Error("Invalid announcement request"):n.response?.data?.error?new Error(n.response.data.error):new Error(`Failed to generate ${y}`)}function le({gameId:n}){const{selectedGame:y,selectedGameId:u}=x.useContext(Q),[h,A]=x.useState(!1),[S,j]=x.useState(!1),[R,W]=x.useState(!1),[K,r]=x.useState(""),[oe,m]=x.useState(null),N=x.useRef(null),$=x.useRef(null),T=x.useRef(!1),[v,q]=x.useState("female"),B="";x.useEffect(()=>{q("female")},[]);const[L,i]=x.useState({current:0,duration:0,isPlaying:!1}),I=x.useRef(null),k=n||u,O=()=>{"speechSynthesis"in window&&speechSynthesis.cancel(),T.current=!1,$.current&&($.current.pause(),$.current.currentTime=0,$.current=null),N.current&&(N.current.pause(),N.current.currentTime=0,N.current=null),r(""),i({current:0,duration:0,isPlaying:!1}),E()},D=e=>{q(e),localStorage.setItem("selectedVoice",e),console.log(`üé§ Voice selection changed to: ${e==="male"?"Al":e==="female"?"Linda":e}`)},G=async()=>{try{"wakeLock"in navigator&&(I.current=await navigator.wakeLock.request("screen"),console.log("Wake lock acquired - screen will stay active"))}catch(e){console.log("Wake lock not supported or failed:",e)}},E=async()=>{if(I.current)try{await I.current.release(),I.current=null,console.log("Wake lock released")}catch(e){console.log("Error releasing wake lock:",e)}},w=async e=>{"speechSynthesis"in window?(speechSynthesis.cancel(),await G(),setTimeout(()=>{const t=new SpeechSynthesisUtterance(e),p=speechSynthesis.getVoices();te(t,p);const b=e.split(" ").length/150*60;t.onstart=()=>{r("Playing announcement..."),i({current:0,duration:b,isPlaying:!0});const l=setInterval(()=>{i(o=>o.current>=o.duration?(clearInterval(l),o):{...o,current:o.current+.1})},100);t.progressInterval=l},t.onend=async()=>{r(""),i({current:0,duration:0,isPlaying:!1}),t.progressInterval&&clearInterval(t.progressInterval),await E()},t.onerror=async l=>{console.error("Speech synthesis error:",l),m("Text-to-speech failed"),r(""),i({current:0,duration:0,isPlaying:!1}),t.progressInterval&&clearInterval(t.progressInterval),await E()},speechSynthesis.speak(t)},100)):(m("Text-to-speech not supported in this browser"),setTimeout(()=>m(null),3e3))},V=async(e,t=200)=>{if(console.log("üé§ playDualAnnouncement called with:",e),console.log("üé§ Conversation type:",typeof e,"Array?",Array.isArray(e)),!e||!Array.isArray(e)||e.length===0){console.error("‚ùå Invalid conversation data:",{conversation:e,isArray:Array.isArray(e),length:e?.length}),m("No conversation data available");return}console.log("‚úÖ Valid conversation data, starting playback..."),r("üé§ Playing Al & Linda conversation..."),await G(),T.current=!0;let p=0;e.forEach(b=>{const l=b.text.split(" ").length;p+=l/150*60}),i({current:0,duration:p,isPlaying:!0});let c=0;try{for(let b=0;b<e.length;b++){if(!T.current){console.log("Al & Linda conversation stopped by user");break}const l=e[b];r(`${l.speaker==="male"?"üßì":"üë©‚Äçü¶∞"} ${l.speaker==="male"?"Al":"Linda"} speaking...`);try{const o=`${B}/api/tts/dual-line`,a=await H.post(o,{text:l.text,speaker:l.speaker,gameId:n});if(a.data.success&&a.data.audioPath){const d=a.data.audioPath,P=`${B}/api/audio/${d}`;await new Promise((f,g)=>{if(!T.current){f();return}const C=new Audio(P);$.current=C,C.oncanplaythrough=()=>{if(!T.current){f();return}C.play().then(()=>{}).catch(g)},C.onended=()=>{c+=l.text.split(" ").length/150*60,i(F=>({...F,current:c})),setTimeout(()=>{f()},t)},C.onerror=F=>{console.error("Dual announcer audio error:",F),g(F)}})}else throw new Error("Failed to generate TTS for dual announcer line")}catch(o){console.error("TTS generation failed, falling back to browser TTS:",o),await new Promise((a,d)=>{if(!T.current){a();return}if("speechSynthesis"in window){const P=new SpeechSynthesisUtterance(l.text),f=speechSynthesis.getVoices();Z(P,l.speaker,f),P.onend=()=>{c+=l.text.split(" ").length/150*60,i(g=>({...g,current:c})),setTimeout(()=>{a()},t)},P.onerror=g=>{console.error("Dual announcer TTS error:",g),d(g)},speechSynthesis.speak(P)}else d(new Error("Speech synthesis not supported"))})}}T.current?(r("Al & Linda conversation complete"),setTimeout(()=>r(""),2e3)):(r("Al & Linda conversation stopped"),setTimeout(()=>r(""),1e3))}catch(b){console.error("Dual announcer playback error:",b),m("Failed to play dual announcer conversation")}finally{T.current=!1,$.current=null,i({current:0,duration:0,isPlaying:!1}),await E()}},_=async()=>{if(!k){m("No game selected. Please select a game first.");return}A(!0),m(null),r("Generating goal announcement...");try{const e=await M("goal",k,v);if(e.success){const{announcement:t,scoreless:p,conversation:c,lineGapMs:b}=e;if((v==="dual"?"dual":"single")==="dual"&&c){await V(c,b||200);return}if(t.audioPath&&typeof t.audioPath=="string"&&t.audioPath.trim()!=="")try{const o=`/api/audio/${t.audioPath}`;console.log("Attempting to play Studio voice audio:",o);const a=new Audio(o);N.current=a;let d=!1,P=!1;a.preload="auto",(async()=>{a.onloadedmetadata=async()=>{r("Playing Studio voice announcement..."),i({current:0,duration:a.duration,isPlaying:!0}),await G()},a.ontimeupdate=()=>{i(g=>({...g,current:a.currentTime}))},a.onended=async()=>{r(""),i({current:0,duration:0,isPlaying:!1}),await E()},a.onerror=async g=>{console.error("Studio audio playback error:",g),i({current:0,duration:0,isPlaying:!1}),await E(),!d&&!P&&(P=!0,console.log("Falling back to browser TTS..."),w(t.text))}})();try{const g=a.play();g!==void 0&&(await g,d=!0,console.log("Studio voice audio playing successfully"))}catch(g){console.log("Studio audio autoplay blocked, using fallback:",g),P||(P=!0,w(t.text))}}catch(o){console.error("Studio audio creation error:",o),console.log("Falling back to browser TTS due to audio creation error"),w(t.text)}else w(t.text)}}catch(e){console.error("Error announcing latest goal:",e);try{U(e,"goal announcement")}catch(t){m(t.message)}r("")}finally{A(!1)}},z=async()=>{if(!k){m("No game selected. Please select a game first.");return}j(!0),m(null),r("Generating penalty announcement...");try{const e=await M("penalty",k,v);if(e.success){const{announcement:t,conversation:p,lineGapMs:c}=e;if((v==="dual"?"dual":"single")==="dual"&&p){await V(p,c||190);return}if(t.audioPath&&typeof t.audioPath=="string"&&t.audioPath.trim()!=="")try{const l=`/api/audio/${t.audioPath}`;console.log("Attempting to play Studio penalty audio:",l);const o=new Audio(l);N.current=o;let a=!1,d=!1;o.preload="auto",(()=>{o.onloadedmetadata=()=>{r("Playing Studio voice penalty announcement..."),i({current:0,duration:o.duration,isPlaying:!0})},o.ontimeupdate=()=>{i(f=>({...f,current:o.currentTime}))},o.onended=()=>{r(""),i({current:0,duration:0,isPlaying:!1})},o.onerror=f=>{console.error("Studio penalty audio playback error:",f),i({current:0,duration:0,isPlaying:!1}),!a&&!d&&(d=!0,console.log("Falling back to browser TTS for penalty..."),w(t.text))}})();try{const f=o.play();f!==void 0&&(await f,a=!0,console.log("Studio voice penalty audio playing successfully"))}catch(f){console.log("Studio penalty audio autoplay blocked, using fallback:",f),d||(d=!0,w(t.text))}}catch(l){console.error("Studio penalty audio creation error:",l),console.log("üîÑ Falling back to browser TTS due to penalty audio creation error"),w(t.text)}else console.log("‚ö†Ô∏è No Studio penalty audio available, using browser TTS fallback"),console.log("AudioPath received:",t.audioPath),w(t.text)}}catch(e){console.error("Error announcing latest penalty:",e);try{U(e,"penalty announcement")}catch(t){e.response?.status===404?m("No penalties recorded yet for this game"):m(t.message)}r("")}finally{j(!1)}},J=async()=>{if(!k){m("No game selected. Please select a game first.");return}W(!0),m(null),r("Generating random commentary...");try{const e=await M("random",k,v);if(console.log("Random commentary response:",e),e.success){const{text:t,audioPath:p,conversation:c,lineGapMs:b}=e;if(console.log("üéôÔ∏è Random commentary data received:",{text:t,audioPath:p,conversation:c}),(v==="dual"?"dual":"single")==="dual"&&c){console.log("üéôÔ∏è Processing dual mode conversation:",c),console.log("üéôÔ∏è Conversation type:",typeof c,"Array?",Array.isArray(c)),Array.isArray(c)&&(console.log("üéôÔ∏è Conversation length:",c.length),c.forEach((o,a)=>{console.log(`üéôÔ∏è Line ${a}:`,o)}));try{await V(c,b||200),r("Random commentary complete!"),setTimeout(()=>r(""),2e3)}catch(o){console.error("‚ùå Error in dual announcer playback:",o),console.error("‚ùå Conversation data that failed:",c),m("Failed to play dual announcer conversation")}return}if(p&&typeof p=="string"&&p.trim()!=="")try{const o=`/api/audio/${p}`;console.log("Playing random commentary audio:",o),r("Playing random commentary...");const a=new Audio(o);N.current=a,a.onloadedmetadata=async()=>{i({current:0,duration:a.duration,isPlaying:!0}),await G()},a.ontimeupdate=()=>{i(d=>({...d,current:a.currentTime}))},a.onended=async()=>{r("Random commentary complete!"),setTimeout(()=>r(""),2e3),i({current:0,duration:0,isPlaying:!1}),await E()},a.onerror=async d=>{console.error("Random commentary audio error:",d),i({current:0,duration:0,isPlaying:!1}),await E(),console.log("Falling back to browser TTS..."),w(t)};try{await a.play(),console.log("‚úÖ Random commentary audio playing successfully")}catch(d){console.log("Audio autoplay blocked, using browser TTS fallback:",d),w(t)}}catch(o){console.error("Random commentary audio creation error:",o),console.log("üîÑ Falling back to browser TTS due to audio creation error"),w(t)}else console.log("‚ö†Ô∏è No Studio audio available, using browser TTS fallback"),console.log("AudioPath received:",p),w(t)}else if(console.log("API response without success flag:",e),e.text)console.log("üì¢ Using text from response for browser TTS"),w(e.text);else throw new Error("No valid response data received")}catch(e){console.error("Error generating random commentary:",e);try{U(e,"random commentary")}catch(t){m(t.message)}r("")}finally{W(!1)}};return s.jsxs("div",{className:"p-3",children:[s.jsx("h4",{className:"text-lg font-semibold mb-2",children:"Announcer"}),s.jsxs("div",{className:"grid grid-cols-2 gap-1 mb-3",children:[s.jsx("button",{onClick:()=>D("male"),className:`min-w-20 h-8 px-2 py-1 rounded transition-all duration-200 text-xs border-2 ${v==="male"?"bg-white text-blue-800 border-blue-800 font-semibold":"bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white border-blue-600"}`,title:"Al (Male Voice)",children:"üßì"}),s.jsx("button",{onClick:_,disabled:h||!k,className:`min-w-20 h-8 px-2 py-1 text-white rounded transition-all duration-200 text-xs ${h||!k?"bg-gray-400 cursor-not-allowed":"bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800"}`,title:"Announce Latest Goal",children:h?"Loading...":"Goal"}),s.jsx("button",{onClick:()=>D("female"),className:`min-w-20 h-8 px-2 py-1 rounded transition-all duration-200 text-xs border-2 ${v==="female"?"bg-white text-blue-800 border-blue-800 font-semibold":"bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white border-blue-600"}`,title:"Linda (Female Voice)",children:"üë©‚Äçü¶∞"}),s.jsx("button",{onClick:z,disabled:S||!k,className:`min-w-20 h-8 px-2 py-1 text-white rounded transition-all duration-200 text-xs ${S||!k?"bg-gray-400 cursor-not-allowed":"bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800"}`,title:"Announce Latest Penalty",children:S?"Loading...":"Penalty"}),s.jsxs("button",{onClick:()=>D("dual"),className:`min-w-20 h-8 px-2 py-1 rounded transition-all duration-200 text-xs border-2 ${v==="dual"?"bg-white text-blue-800 border-blue-800 font-semibold":"bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white border-blue-600"}`,title:"Al & Linda (Dual Announcers)",children:[s.jsx("span",{children:"üßì"}),s.jsx("span",{children:"üë©‚Äçü¶∞"})]}),s.jsx("button",{onClick:J,disabled:R||!k,className:`min-w-20 h-8 px-2 py-1 text-white rounded transition-all duration-200 text-xs ${R||!k?"bg-gray-400 cursor-not-allowed":"bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800"}`,title:"Random Commentary",children:R?"Loading...":"Random"}),s.jsx("div",{})," ",s.jsx("div",{})," "]}),L.isPlaying&&s.jsxs("div",{className:"mt-2 p-2 bg-gray-50 rounded border",children:[s.jsxs("div",{className:"flex items-center justify-between text-xs text-gray-600 mb-1",children:[s.jsx("span",{children:"Audio Progress"}),s.jsxs("span",{children:[Math.round(L.current),"s / ",Math.round(L.duration),"s"]})]}),s.jsx("div",{className:"w-full bg-gray-200 rounded-full h-1",children:s.jsx("div",{className:"bg-blue-500 h-1 rounded-full transition-all duration-100",style:{width:`${Math.min(L.current/L.duration*100,100)}%`}})})]}),L.isPlaying&&s.jsx("div",{className:"mt-2",children:s.jsx("button",{onClick:O,className:"flex items-center justify-center w-full px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded text-sm font-medium transition-colors",title:"Stop Audio",children:"Stop"})}),L.isPlaying===!1&&K&&(h||S||R)&&s.jsx("p",{className:"text-sm text-gray-500 mt-2 text-center",children:"Audio playing..."})]})}export{le as A};
